using HBS.ImplementationAutomationConsole.Core.BLL.IServices;
using HBS.ImplementationAutomationConsole.Core.DataAccess.IRepository;
using System.Text;

namespace HBS.ImplementationAutomationConsole.Core.BLL.Services
{
    public class SignOffService : ISignOffService
    {
        private readonly IDashboardRepository _idashboardRepository;
        private readonly ISignOffRepository _isignOffRepository;

        public SignOffService(IDashboardRepository dashboardRepository, ISignOffRepository signOffRepository)
        {
            _idashboardRepository = dashboardRepository;
            _isignOffRepository = signOffRepository;
        }

        public async Task<string> GetModuleNameFromSubsection(string subsectionName)
        {
            var moduleAndSubsectionInfo = await _idashboardRepository.GetModuleAndSubsectioninfoFromSubsectionName(subsectionName);
            return moduleAndSubsectionInfo.Item3;
        }

        public async Task<String> GetSignOffHtmlString(string name, DateTime dateOfApproval, string approvalStatus,
            string moduleName, string subsectionName, string comment, string userName)
        {
            var folderDirectory = System.IO.Path.Combine(Directory.GetCurrentDirectory(), "Images");
            var imagePath = Path.Combine(folderDirectory, "logo.png");
            string base64Image = string.Empty;
            if (System.IO.File.Exists(imagePath))
            {
                byte[] imageBytes = System.IO.File.ReadAllBytes(imagePath);
                base64Image = Convert.ToBase64String(imageBytes);
            }

            var status = string.Empty;
            if (approvalStatus == "Approved")
            {
                status = "Confirmed";
            }
            else if (approvalStatus == "Rejected")
            {
                status = "Deleted";
            }

            StringBuilder htmlStringBuilder = new StringBuilder();
            htmlStringBuilder.Append("<div style=\"background-color: #f2f2f2;\">\r\n    <table class=\"table\" width=\"100%\" align=\"center\" cellspacing=\"0\" cellpadding=\"0\">\r\n        <tr>\r\n            <td align=\"center\">\r\n                <div style=\"width:767px; height:100%; background-color: #ffffff;\">\r\n                    <table class=\"table\" width=\"100%\" align=\"center\" cellspacing=\"0\" cellpadding=\"0\">\r\n                        <tr>\r\n                            <td>\r\n                                <div style=\"background-color: #1ab394; height:30px; width: 100%; display: block;\"></div>\r\n                            </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td>\r\n                                <div style=\"padding:30px 45px;\">\r\n                                    <table class=\"table\" width=\"100%\" align=\"center\" cellspacing=\"0\" cellpadding=\"0\">\r\n                                        <tr>\r\n                                            <td align=\"center\">");
            htmlStringBuilder.Append($"<img src=\"data:image/png;base64,{base64Image}\" alt=\"PeopleHR Logo\"\\                                                    style=\"width:250px; margin:0 auto;\">");
            htmlStringBuilder.Append("</td>\r\n                                        </tr>\r\n                                        <tr>\r\n                                            <td>\r\n                                                <h2 style=\"font-family: Segoe UI; font-weight:bold; text-align:center;\">\r\n                                                    PeopleHR Config Assist - Approval Report</h2>\r\n                                                <span\r\n                                                    style=\"display:block; height:2px; background-color:#000; width:200px; margin:0 auto;\"></span>\r\n                                                <div style=\"margin-top:45px;\">\r\n                                                    <p\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        This report serves as a confirmation of the approval action\r\n                                                        taken\r\n                                                        by <span class=\"system-value\" style=\"font-weight:600;\"><b>[Approval Person's Name]</b></span> on <span class=\"system-value\"\r\n                                                            style=\"font-weight:600;\"><b>[Date of Approval]</b></span>.</p>\r\n\r\n                                                    <p\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        The confirmation status for this subsection is <span\r\n                                                            class=\"system-value\"\r\n                                                            style=\"font-weight:600;\"><b>[Accepted/Rejected]</b></span>,\r\n                                                        with the following comment provided:</p>\r\n                                                    <p><span class=\"system-value\"\r\n                                                            style=\"font-family: Segoe UI; font-weight: 600; text-align:left; font-size: 16px;\"><b>[Comment provided during process]</b></span></p>\r\n                                                </div>\r\n                                                <div style=\"margin-top: 40px;\">\r\n                                                    <table\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Module:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                                <span style=\"margin-right: 10px;\"></span><span class=\"system-value\"><b>[Main Module Name]</b></span><br>\r\n                                                            </td>\r\n                                                        </tr>\r\n   <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                                     <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Subsection:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                                <span style=\"margin-right: 10px;\"></span><span class=\"system-value\"><b>[Subsection Name]</b></span><br></td>\r\n                                                        </tr>\r\n      <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                                  <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Confirming Person:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                               <span style=\"margin-right: 10px;\"></span>\r\n <span class=\"system-value\"><b>[Approval Person's Name]</b></span><br></td>\r\n                                                        </tr>\r\n             <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                           <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Date of Confirmation:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                                <span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Date of Approval]</b></span><br>\r\n                                                            </td>\r\n                                                        </tr>\r\n                   <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                     <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Confirmation Status:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                                <span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Accepted/Rejected]</b></span><br>\r\n                                                            </td>\r\n                                                        </tr>\r\n                          <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                              <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Comment:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                               <span style=\"margin-right: 10px;\"></span>\r\n <span class=\"system-value\"><b>[Comment provided during approval process]</b></span><br></td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td></td>\r\n                                                            <td></td>\r\n                                                        </tr>\r\n                                                    </table>\r\n                                                </div>\r\n                                                <div style=\"margin-top: 40px;\">\r\n                                                    <table\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Digital Signature:      </td>\r\n                                                            <td><span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Approval Person's Username]</b></span><br></td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Date:  </td>\r\n                                                            <td><span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Date of Approval]</b></span>\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                    </table>\r\n                                                </div>\r\n                                            </td>\r\n                                        </tr>\r\n\r\n                                    </table>\r\n                                </div>\r\n                            </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td style=\"height:70px;\">\r\n                                <div></div>\r\n                            </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td align=\" center\">\r\n                                <div\r\n                                    style=\"height:70px; width:100%;display:block;background-color:#e0e0e0;text-align:center;line-height:70px;font-family: Segoe UI;font-size: 13px;\">\r\n                                    Copyright @ hSenid Business Solutions &copy; 2004-2023, All Rights\r\n                                    Reserved.\r\n                                </div>\r\n                            </td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    </table>\r\n</div>");

            htmlStringBuilder.Replace("[Approval Person's Name]", name);
            htmlStringBuilder.Replace("[Date of Approval]", dateOfApproval.ToString("dd-MM-yyyy"));
            htmlStringBuilder.Replace("[Accepted/Rejected]", status);
            htmlStringBuilder.Replace("[Comment provided during process]", comment);
            htmlStringBuilder.Replace("[Comment provided during approval process]", comment);
            htmlStringBuilder.Replace("[Main Module Name]", moduleName);
            htmlStringBuilder.Replace("[Subsection Name]", subsectionName);
            htmlStringBuilder.Replace("[Approval Person's Username]", userName);

            var htmlString = htmlStringBuilder.ToString();
            return htmlString;
        }

        public async Task<String> GetSignOffHtmlStringForConfiguration(string name, DateTime dateOfApproval, string approvalStatus,
            string comment, string userName, string sectionName)
        {
            var folderDirectory = System.IO.Path.Combine(Directory.GetCurrentDirectory(), "Images");
            var imagePath = Path.Combine(folderDirectory, "logo.png");
            string base64Image = string.Empty;
            if (System.IO.File.Exists(imagePath))
            {
                byte[] imageBytes = System.IO.File.ReadAllBytes(imagePath);
                base64Image = Convert.ToBase64String(imageBytes);
            }

            var status = string.Empty;
            if(approvalStatus=="Approved")
            {
                status = "Confirmed";
            }
            else if(approvalStatus=="Rejected")
            {
                status = "Deleted";
            }

            StringBuilder htmlStringBuilder = new StringBuilder();
            htmlStringBuilder.Append("<div style=\"background-color: #f2f2f2;\">\r\n    <table class=\"table\" width=\"100%\" align=\"center\" cellspacing=\"0\" cellpadding=\"0\">\r\n        <tr>\r\n            <td align=\"center\">\r\n                <div style=\"width:767px; height:100%; background-color: #ffffff;\">\r\n                    <table class=\"table\" width=\"100%\" align=\"center\" cellspacing=\"0\" cellpadding=\"0\">\r\n                        <tr>\r\n                            <td>\r\n                                <div style=\"background-color: #1ab394; height:30px; width: 100%; display: block;\"></div>\r\n                            </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td>\r\n                                <div style=\"padding:30px 45px;\">\r\n                                    <table class=\"table\" width=\"100%\" align=\"center\" cellspacing=\"0\" cellpadding=\"0\">\r\n                                        <tr>\r\n                                            <td align=\"center\">");
            htmlStringBuilder.Append($"<img src=\"data:image/png;base64,{base64Image}\" alt=\"PeopleHR Logo\"\\                                                    style=\"width:250px; margin:0 auto;\">");
            htmlStringBuilder.Append("</td>\r\n                                        </tr>\r\n                                        <tr>\r\n                                            <td>\r\n                                                <h2 style=\"font-family: Segoe UI; font-weight:bold; text-align:center;\">\r\n                                                    PeopleHR Config Assist - Approval Report</h2>\r\n                                                <span\r\n                                                    style=\"display:block; height:2px; background-color:#000; width:200px; margin:0 auto;\"></span>\r\n                                                <div style=\"margin-top:45px;\">\r\n                                                    <p\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        This report serves as a confirmation of the approval action\r\n                                                        taken\r\n                                                        by <span class=\"system-value\" style=\"font-weight:600;\"><b>[Approval Person's Name]</b></span> on <span class=\"system-value\"\r\n                                                            style=\"font-weight:600;\"><b>[Date of Approval]</b></span>.</p>\r\n\r\n                                                    <p\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        The confirmation status for the [Section_Name] is <span\r\n                                                            class=\"system-value\"\r\n                                                            style=\"font-weight:600;\"><b>[Accepted/Rejected]</b></span>,\r\n                                                        with the following comment provided:</p>\r\n                                                    <p><span class=\"system-value\"\r\n                                                            style=\"font-family: Segoe UI; font-weight: 600; text-align:left; font-size: 16px;\"><b>[Comment provided during process]</b></span></p>\r\n                                                </div>\r\n                                                <div style=\"margin-top: 40px;\">\r\n                                                    <table\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                 <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                                  <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Confirming Person:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                               <span style=\"margin-right: 10px;\"></span>\r\n <span class=\"system-value\"><b>[Approval Person's Name]</b></span><br></td>\r\n                                                        </tr>\r\n             <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                           <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Date of Confiramtion:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                                <span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Date of Approval]</b></span><br>\r\n                                                            </td>\r\n                                                        </tr>\r\n                   <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                                     <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Confirmation Status:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                                <span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Accepted/Rejected]</b></span><br>\r\n                                                            </td>\r\n                                                        </tr>\r\n                          <tr>\r\n\t<td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n</tr>                              <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Comment:      </td>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                               <span style=\"margin-right: 10px;\"></span>\r\n <span class=\"system-value\"><b>[Comment provided during approval process]</b></span><br></td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td></td>\r\n                                                            <td></td>\r\n                                                        </tr>\r\n                                                    </table>\r\n                                                </div>\r\n                                                <div style=\"margin-top: 40px;\">\r\n                                                    <table\r\n                                                        style=\"font-family: Segoe UI; font-weight:normal; text-align:left; font-size: 16px;\">\r\n                                                        <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Digital Signature:      </td>\r\n                                                            <td><span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Approval Person's Username]</b></span><br></td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td colspan=\"2\" style=\"padding-bottom: 15px;\"></td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td\r\n                                                                style=\"font-family: Segoe UI; font-weight:600; text-align:left; font-size: 16px;\">\r\n                                                                Date:  </td>\r\n                                                            <td><span style=\"margin-right: 10px;\"></span>\r\n<span class=\"system-value\"><b>[Date of Approval]</b></span>\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                    </table>\r\n                                                </div>\r\n                                            </td>\r\n                                        </tr>\r\n\r\n                                    </table>\r\n                                </div>\r\n                            </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td style=\"height:70px;\">\r\n                                <div></div>\r\n                            </td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td align=\" center\">\r\n                                <div\r\n                                    style=\"height:70px; width:100%;display:block;background-color:#e0e0e0;text-align:center;line-height:70px;font-family: Segoe UI;font-size: 13px;\">\r\n                                    Copyright @ hSenid Business Solutions &copy; 2004-2023, All Rights\r\n                                    Reserved.\r\n                                </div>\r\n                            </td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n            </td>\r\n        </tr>\r\n    </table>\r\n</div>");

            htmlStringBuilder.Replace("[Approval Person's Name]", name);
            htmlStringBuilder.Replace("[Date of Approval]", dateOfApproval.ToString("dd-MM-yyyy"));
            htmlStringBuilder.Replace("[Accepted/Rejected]", status);
            htmlStringBuilder.Replace("[Comment provided during process]", comment);
            htmlStringBuilder.Replace("[Comment provided during approval process]", comment);
            htmlStringBuilder.Replace("[Approval Person's Username]", userName);
            htmlStringBuilder.Replace("[Section_Name]", sectionName);

            var htmlString = htmlStringBuilder.ToString();
            return htmlString;
        }

        public async Task<byte[]> GetSignOffPdfAsByteArray(int recordId)
        {
            var pdfBytes = await _isignOffRepository.GetPDFByteArray(recordId);
            return pdfBytes;
        }
    }
}